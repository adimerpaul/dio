import{_ as Q,c as h,o as n,w as u,b as e,a,al as g,a0 as m,f as p,d as S,$ as r,a1 as v,a2 as f,t as l,Z as c,h as U,Q as P,e as x,W as b,a3 as w,an as q}from"./index-D7Cm6sAG.js";import{Q as y}from"./QSelect-DeNJPlJQ.js";import{Q as V}from"./QBadge-DE0-9xut.js";import{Q as D}from"./QSpinnerDots-K85J8Y39.js";import{Q as k}from"./QMarkupTable-CjOUbuyY.js";import{Q as I}from"./QPagination-DF13Vl7I.js";import{Q as E}from"./QSpace-Deh0-ZvT.js";import{Q as F}from"./QPage-DNwC6DIF.js";import{C as R}from"./ClosePopup-B78SW9td.js";import"./format-lLrkQFCh.js";const N={name:"Auditorias",data(){const i=new Date,t=_=>_.toISOString().slice(0,10);return{loading:!1,rows:{data:[],last_page:1,total:0,from:0,to:0},page:1,perPage:10,search:"",event:"",type:"",start:t(new Date(i.getFullYear(),i.getMonth(),1)),end:t(i),dlg:!1,showRow:null,eventOptions:[{label:"Todos",value:""},{label:"created",value:"created"},{label:"updated",value:"updated"},{label:"deleted",value:"deleted"}],typeOptions:[{label:"Todas",value:""},{label:"Caso",value:"Caso"},{label:"Problematica",value:"Problematica"},{label:"SesionPsicologica",value:"SesionPsicologica"},{label:"Informe",value:"Informe"},{label:"Documento",value:"Documento"},{label:"Fotografia",value:"Fotografia"},{label:"User",value:"User"}]}},mounted(){this.fetchRows()},methods:{async fetchRows(){this.loading=!0;try{const i=await this.$axios.get("/audits",{params:{q:this.search||"",event:this.event||"",type:this.type||"",start:this.start||"",end:this.end||"",page:this.page,per_page:this.perPage}});this.rows=i.data||{data:[],last_page:1,total:0}}catch(i){this.$q.notify({type:"negative",message:i?.response?.data?.message||"No se pudo cargar auditorías"})}finally{this.loading=!1}},onSearch(){this.page=1,this.fetchRows()},clearSearch(){this.search="",this.onSearch()},goFirst(){this.page=1,this.fetchRows()},badgeColor(i){return i==="created"?"green":i==="updated"?"orange":i==="deleted"?"red":"grey"},async openShow(i){try{const t=await this.$axios.get(`/audits/${i.id}`);this.showRow=t.data||null,this.dlg=!0}catch(t){this.$q.notify({type:"negative",message:t?.response?.data?.message||"No se pudo cargar detalle"})}},pretty(i){return typeof i=="object"?JSON.stringify(i,null,2):String(i)},goToEntity(i){i&&(i.startsWith("/")?this.$router.push(i):window.open(i,"_blank"))}}},A={class:"row items-center q-col-gutter-md q-mb-md"},B={class:"col-12 col-md"},O={class:"col-auto"},T={class:"col-auto"},j={class:"col-auto"},H={class:"col-auto"},L={class:"col-auto"},M={class:"col-auto"},Y={key:0},z={class:"text-grey-8"},W={class:"text-no-wrap"},J={class:"text-weight-medium"},Z={key:0,class:"text-caption text-grey-7"},G={class:"text-grey-7"},K={class:"text-caption ellipsis"},X={key:0},$={key:0,class:"text-caption text-grey-7"},ee={key:1,class:"text-grey"},te={class:"text-no-wrap"},se={key:1},oe={key:2},le={colspan:"7",class:"text-center"},ie={class:"row items-center justify-between q-mt-md"},ae={class:"text-caption text-grey-7"},ne={class:"text-subtitle1"},de={class:"row q-col-gutter-md"},re={class:"col-12 col-md-6"},ue={class:"col-12 col-md-6"},ce={class:"col-12 col-md-6"},pe={key:0,class:"text-caption text-grey-7"},me={class:"col-12 col-md-6"},he={class:"text-caption text-grey-7 ellipsis"},ge={class:"col-12"},we={class:"col-12"},ye={class:"text-no-wrap"},_e={class:"m-pre"},ve={class:"m-pre"},fe={key:1,class:"text-grey"},xe={class:"col-12"},be={class:"col-12 col-md-6"},Ve={class:"col-12 col-md-6"},ke=["title"],Re={class:"col-12"},Ce=["title"];function Qe(i,t,_,Se,s,d){return n(),h(F,{class:"q-pa-md"},{default:u(()=>[e("div",A,[e("div",B,[a(g,{modelValue:s.search,"onUpdate:modelValue":[t[0]||(t[0]=o=>s.search=o),d.onSearch],outlined:"",dense:"",debounce:"400",placeholder:"Buscar por usuario, evento, modelo, IP, URL, texto en cambios…"},{prepend:u(()=>[a(S,{name:"search"})]),append:u(()=>[s.search?(n(),h(p,{key:0,flat:"",dense:"",round:"",icon:"close",onClick:d.clearSearch},null,8,["onClick"])):m("",!0)]),_:1},8,["modelValue","onUpdate:modelValue"])]),e("div",O,[a(y,{modelValue:s.type,"onUpdate:modelValue":[t[1]||(t[1]=o=>s.type=o),d.goFirst],options:s.typeOptions,dense:"",outlined:"",style:{width:"180px"},label:"Entidad"},null,8,["modelValue","options","onUpdate:modelValue"])]),e("div",T,[a(y,{modelValue:s.event,"onUpdate:modelValue":[t[2]||(t[2]=o=>s.event=o),d.goFirst],options:s.eventOptions,dense:"",outlined:"",style:{width:"160px"},label:"Evento"},null,8,["modelValue","options","onUpdate:modelValue"])]),e("div",j,[a(g,{modelValue:s.start,"onUpdate:modelValue":t[3]||(t[3]=o=>s.start=o),type:"date",dense:"",outlined:"",label:"Desde",style:{width:"150px"}},null,8,["modelValue"])]),e("div",H,[a(g,{modelValue:s.end,"onUpdate:modelValue":t[4]||(t[4]=o=>s.end=o),type:"date",dense:"",outlined:"",label:"Hasta",style:{width:"150px"}},null,8,["modelValue"])]),e("div",L,[a(y,{modelValue:s.perPage,"onUpdate:modelValue":[t[5]||(t[5]=o=>s.perPage=o),d.goFirst],options:[10,20,50],dense:"",outlined:"",style:{width:"120px"},label:"Por página"},null,8,["modelValue","onUpdate:modelValue"])]),e("div",M,[a(p,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:s.loading,onClick:d.fetchRows},null,8,["loading","onClick"])])]),a(k,{flat:"",bordered:"",dense:""},{default:u(()=>[t[12]||(t[12]=e("thead",null,[e("tr",null,[e("th",{style:{width:"70px"}},"#"),e("th",{style:{width:"130px"}},"Fecha"),e("th",{style:{width:"120px"}},"Evento"),e("th",{style:{width:"190px"}},"Usuario"),e("th",null,"Entidad"),e("th",null,"Cambios"),e("th",{style:{width:"130px"}},"Acciones")])],-1)),!s.loading&&s.rows.data.length?(n(),r("tbody",Y,[(n(!0),r(v,null,f(s.rows.data,(o,Ue)=>(n(),r("tr",{key:o.id},[e("td",z,"#"+l(o.id),1),e("td",W,l(i.$filters.dateDmYHis(o.created_at)),1),e("td",null,[a(V,{color:d.badgeColor(o.event),align:"middle",class:"q-px-sm"},{default:u(()=>[c(l(o.event),1)]),_:2},1032,["color"])]),e("td",null,[e("div",J,l(o.user_label||"—"),1),o.ip_address?(n(),r("div",Z,"IP "+l(o.ip_address),1)):m("",!0)]),e("td",null,[e("div",null,[e("b",null,l(o.model_short),1),t[9]||(t[9]=c()),e("span",G,"#"+l(o.auditable_id),1)]),e("div",K,l(o.auditable_type),1)]),e("td",null,[o.changed_count?(n(),r("div",X,[c(l(o.changed_count)+" campo(s) ",1),o.summary_fields?.length?(n(),r("span",$," — "+l(o.summary_fields.join(", ")),1)):m("",!0)])):(n(),r("span",ee,"—"))]),e("td",te,[a(p,{dense:"",flat:"",icon:"visibility",onClick:C=>d.openShow(o)},null,8,["onClick"]),o.entity_route?(n(),h(p,{key:0,dense:"",flat:"",icon:"open_in_new",onClick:C=>d.goToEntity(o.entity_route)},null,8,["onClick"])):m("",!0)])]))),128))])):s.loading?(n(),r("tbody",oe,[e("tr",null,[e("td",le,[a(D,{size:"24px",class:"q-mr-sm"}),t[11]||(t[11]=c(" Cargando… "))])])])):(n(),r("tbody",se,t[10]||(t[10]=[e("tr",null,[e("td",{colspan:"7",class:"text-center text-grey q-pa-lg"},"Sin resultados")],-1)])))]),_:1}),e("div",ie,[e("div",ae,[t[13]||(t[13]=c(" Mostrando ")),e("b",null,l(s.rows.from||0),1),t[14]||(t[14]=c("–")),e("b",null,l(s.rows.to||0),1),t[15]||(t[15]=c(" de ")),e("b",null,l(s.rows.total||0),1)]),a(I,{modelValue:s.page,"onUpdate:modelValue":[t[6]||(t[6]=o=>s.page=o),d.fetchRows],max:s.rows.last_page||1,"boundary-numbers":"","direction-links":""},null,8,["modelValue","max","onUpdate:modelValue"])]),a(U,{modelValue:s.dlg,"onUpdate:modelValue":t[8]||(t[8]=o=>s.dlg=o),persistent:""},{default:u(()=>[a(P,{style:{"max-width":"900px",width:"95vw"}},{default:u(()=>[a(x,{class:"row items-center q-pb-none"},{default:u(()=>[e("div",ne,"Detalle de auditoría #"+l(s.showRow?.audit?.id),1),a(E),b(a(p,{flat:"",round:"",dense:"",icon:"close"},null,512),[[R]])]),_:1}),a(x,{class:"q-gutter-sm"},{default:u(()=>[e("div",de,[e("div",re,[t[16]||(t[16]=e("div",{class:"text-caption text-grey-7"},"Evento",-1)),e("div",null,[a(V,{color:d.badgeColor(s.showRow?.audit?.event)},{default:u(()=>[c(l(s.showRow?.audit?.event),1)]),_:1},8,["color"])])]),e("div",ue,[t[17]||(t[17]=e("div",{class:"text-caption text-grey-7"},"Fecha",-1)),e("div",null,l(i.$filters.dateDmYHis(s.showRow?.audit?.created_at)),1)]),e("div",ce,[t[18]||(t[18]=e("div",{class:"text-caption text-grey-7"},"Usuario",-1)),e("div",null,l(s.showRow?.audit?.user_name||s.showRow?.audit?.user_username||"—"),1),s.showRow?.audit?.user_email?(n(),r("div",pe,l(s.showRow.audit.user_email),1)):m("",!0)]),e("div",me,[t[19]||(t[19]=e("div",{class:"text-caption text-grey-7"},"Entidad",-1)),e("div",null,[e("b",null,l(s.showRow?.audit?.model_short),1),c(" #"+l(s.showRow?.audit?.auditable_id),1)]),e("div",he,l(s.showRow?.audit?.auditable_type),1)]),e("div",ge,[a(w)]),e("div",we,[t[21]||(t[21]=e("div",{class:"text-subtitle2 q-mb-xs"},"Cambios",-1)),s.showRow?.diff?.length?(n(),h(k,{key:0,dense:"",flat:"",bordered:""},{default:u(()=>[t[20]||(t[20]=e("thead",null,[e("tr",null,[e("th",{style:{width:"220px"}},"Campo"),e("th",null,"Antes"),e("th",null,"Después")])],-1)),e("tbody",null,[(n(!0),r(v,null,f(s.showRow.diff,o=>(n(),r("tr",{key:o.field},[e("td",ye,l(o.field),1),e("td",null,[e("pre",_e,l(d.pretty(o.old)),1)]),e("td",null,[e("pre",ve,l(d.pretty(o.new)),1)])]))),128))])]),_:1})):(n(),r("div",fe,"No hay diferencias (o registro de creación/eliminación sin valores)."))]),e("div",xe,[a(w)]),e("div",be,[t[22]||(t[22]=e("div",{class:"text-caption text-grey-7"},"IP",-1)),e("div",null,l(s.showRow?.audit?.ip_address||"—"),1)]),e("div",Ve,[t[23]||(t[23]=e("div",{class:"text-caption text-grey-7"},"URL",-1)),e("div",{class:"ellipsis",title:s.showRow?.audit?.url},l(s.showRow?.audit?.url||"—"),9,ke)]),e("div",Re,[t[24]||(t[24]=e("div",{class:"text-caption text-grey-7"},"User Agent",-1)),e("div",{class:"ellipsis-3",title:s.showRow?.audit?.user_agent},l(s.showRow?.audit?.user_agent||"—"),9,Ce)])])]),_:1}),a(w),a(q,{align:"right"},{default:u(()=>[b(a(p,{flat:"",label:"Cerrar"},null,512),[[R]]),s.showRow?.audit?.entity_route?(n(),h(p,{key:0,color:"primary",label:"Ir al registro",onClick:t[7]||(t[7]=o=>d.goToEntity(s.showRow.audit.entity_route))})):m("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Te=Q(N,[["render",Qe],["__scopeId","data-v-5f1ae957"]]);export{Te as default};
