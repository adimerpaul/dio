import{_ as S,Y,c as v,o as h,w as d,a as o,b as s,$ as C,Q as p,e as x,a6 as w,f as y,a0 as T,a1 as F,a2 as E,t as u,a3 as O,Z as Q}from"./index-tEaV_suc.js";import{Q as V}from"./QSelect-7SV4y04Y.js";import{Q as M,a as z}from"./QTable-CZIZYyGW.js";import{Q as N}from"./QPage-CezfwX8s.js";import{m as P}from"./vue3-apexcharts-Cp5Qru-w.js";import{h as g}from"./moment-C5S46NFB.js";import{E as I,a as W}from"./jspdf.plugin.autotable-YJs03axq.js";import"./QChip-wb55BxGN.js";import"./QItem-BFEJhtlp.js";import"./QItemLabel-WW9EvA0g.js";import"./QMenu-MF9hz9C1.js";import"./position-engine-BS4hZsDu.js";import"./format-CJebrXOQ.js";import"./QList-BY-ybt9S.js";import"./QMarkupTable-C0DQYA4_.js";import"./use-fullscreen-OC80E1UE.js";const L={name:"IndexPage",components:{apexchart:P},data(){return{loading:!1,filters:{from:g().format("YYYY-MM-DD"),to:g().format("YYYY-MM-DD"),area:null},rango:{from:null,to:null},totales:{casos:0,denunciantes:0,denunciados:0},porArea:{labels:[],data:[]},porTipo:{labels:[],data:[]},porTipologia:{labels:[],data:[]},porEdad:{labels:[],data:[]},seriesTiempo:{labels:[],data:[]},porFragancia:{labels:[],data:[]},filterOptions:{areas:[]},detalle:{titulo:"",rows:[],loading:!1},detalleColumns:[{name:"id",label:"ID",field:"id",sortable:!0,align:"left"},{name:"area",label:"Área",field:"area",align:"left"},{name:"tipo",label:"Tipo",field:"tipo",align:"left"},{name:"caso_tipologia",label:"Tipología",field:"caso_tipologia",align:"left"},{name:"caso_numero",label:"N° Caso",field:"caso_numero",align:"left"},{name:"caso_fecha_hecho",label:"Fecha hecho",field:"caso_fecha_hecho",align:"left"},{name:"caso_lugar_hecho",label:"Lugar",field:"caso_lugar_hecho",align:"left"},{name:"fecha_apertura_caso",label:"Fecha apertura",field:"fecha_apertura_caso",align:"left"},{name:"zona",label:"Zona",field:"zona",align:"left"},{name:"denunciantes",label:"Denunciantes",field:a=>a.denunciantes?.map(e=>e.denunciante_nombres).join(", ")||"—",align:"left"},{name:"denunciados",label:"Denunciados",field:a=>a.denunciados?.map(e=>e.denunciado_nombres).join(", ")||"—",align:"left"},{name:"user",label:"Usuario",field:a=>a.user?.name||"—",align:"left"}]}},computed:{cards(){return[{key:"casos",label:"Casos",value:this.totales.casos},{key:"denunciante",label:"Denunciantes",value:this.totales.denunciantes},{key:"denunciado",label:"Denunciados",value:this.totales.denunciados}]},rangoTexto(){return!this.rango.from||!this.rango.to?"":`Del ${this.rango.from} al ${this.rango.to}`},barEdadOptions(){return{chart:{toolbar:{show:!1}},xaxis:{categories:this.porEdad.labels},dataLabels:{enabled:!1},plotOptions:{bar:{horizontal:!1,columnWidth:"40%"}},grid:{borderColor:"#eee"}}},barEdadSeries(){return[{name:"Casos",data:this.porEdad.data}]},areaOptions(){return{chart:{toolbar:{show:!1}},stroke:{curve:"smooth",width:2},dataLabels:{enabled:!1},xaxis:{categories:this.seriesTiempo.labels},grid:{borderColor:"#eee"},legend:{position:"top"}}},areaSeries(){return[{name:"Casos",data:this.seriesTiempo.data}]}},mounted(){this.fetchDashboard()},methods:{imprimirDetalle(){if(!this.detalle?.rows?.length){this.$q.notify({type:"warning",message:"No hay detalle para imprimir"});return}const a=new I("l","mm","a4"),e=l=>l?g(l).format("DD/MM/YYYY"):"—",r=l=>l==null||l===""?"—":String(l),b="Reporte de Casos",t=r(this.detalle.titulo||"Detalle"),n=`Rango: ${this.filters.from}  →  ${this.filters.to}`,c=this.filters.area?`Área: ${this.filters.area}`:"Área: Todas",i=`Generado: ${g().format("DD/MM/YYYY HH:mm")}`;a.setFont("helvetica","bold"),a.setFontSize(14),a.text(b,10,14),a.setFont("helvetica","normal"),a.setFontSize(10),a.text(t,10,20),a.text(n,10,25),a.text(c,10,30),a.text(i,10,35);const m=[["ID","Área","Tipo","Tipología","N° Caso","Fecha hecho","Fecha apertura","Usuario","Zona","Denunciantes","Denunciados"]],D=this.detalle.rows.map(l=>[r(l.id),r(l.area),r(l.tipo),r(l.caso_tipologia),r(l.caso_numero),e(l.caso_fecha_hecho),l.fecha_apertura_caso?g(l.fecha_apertura_caso).format("DD/MM/YYYY"):"—",r(l.user?.name),r(l.zona),l.denunciantes?.map(f=>f.denunciante_nombres).filter(Boolean).join(", ")||"—",l.denunciados?.map(f=>f.denunciado_nombres).filter(Boolean).join(", ")||"—"]),q=a.internal.pageSize.getWidth(),_=8,k=q-_*2;W(a,{head:m,body:D,startY:40,theme:"grid",margin:{left:_,right:_},tableWidth:k,styles:{font:"helvetica",fontSize:8,cellPadding:2,overflow:"linebreak",valign:"top",cellWidth:"auto"},headStyles:{fontStyle:"bold",fontSize:8},columnStyles:{9:{cellWidth:55},10:{cellWidth:55}},didDrawPage:()=>{const l=a.getNumberOfPages(),f=a.internal.pageSize.getHeight();a.setFontSize(9),a.text(`Página ${a.internal.getCurrentPageInfo().pageNumber} de ${l}`,_,f-6)}}),a.save(`casos_${this.filters.from}_${this.filters.to}.pdf`)},formatDate(a){return a||""},getDonutOptions(a,e,r){const b=this;return{labels:e,legend:{position:"bottom"},dataLabels:{enabled:!0},chart:{toolbar:{show:!1},events:{dataPointSelection(t,n,c){const i=c.dataPointIndex,m=e[i];m&&b.onDonutClick(r,m)}}},title:{text:"",align:"left"}}},async onDonutClick(a,e){this.detalle.titulo=a==="tipo"?`Casos - Tipo: ${e}`:a==="tipologia"?`Casos - Tipología: ${e}`:`Casos - ${e}`,this.detalle.loading=!0,this.detalle.rows=[];try{const r=await this.$axios.get("dashboard-casos-detalle",{params:{from:this.filters.from,to:this.filters.to,area:this.filters.area,group_by:a,value:e}});this.detalle.rows=r.data||[]}catch(r){console.error(r),this.$q.notify({type:"negative",message:"Error cargando detalle de casos"})}finally{this.detalle.loading=!1}},async fetchDashboard(){this.loading=!0;try{const e=(await this.$axios.get("dashboard-casos",{params:this.filters})).data||{};this.totales=e.totales||this.totales,this.porArea=e.por_area||this.porArea,this.porTipo=e.por_tipo||this.porTipo,this.porTipologia=e.por_tipologia||this.porTipologia,this.porEdad=e.por_edad||this.porEdad,this.seriesTiempo=e.series_tiempo||this.seriesTiempo,this.porFragancia=e.por_fragancia||this.porFragancia,this.filterOptions.areas=e.filtros?.areas||[],this.rango=e.rango||this.rango}catch(a){console.error(a),this.$q.notify({type:"negative",message:"Error cargando dashboard de casos"})}finally{this.loading=!1}}}},A={class:"col-12 col-sm-3"},H={class:"col-12 col-sm-3"},j={class:"col-12 col-sm-3"},B={class:"col-12 col-sm-auto"},U={class:"row q-col-gutter-md q-mb-md"},R={class:"text-caption text-grey-7"},Z={class:"text-h4 q-my-sm"},G={class:"text-caption text-positive"},X={class:"row q-col-gutter-md q-mb-md"},J={class:"col-12 col-md-4"},K={class:"col-12 col-md-4"},$={class:"col-12 col-md-4"},ee={class:"row q-col-gutter-md"},ae={class:"col-12 col-md-6"},te={class:"col-12 col-md-6"},oe={class:"text-subtitle2"},se={class:"text-caption text-grey-7"};function le(a,e,r,b,t,n){const c=Y("apexchart");return h(),v(N,{class:"q-pa-md bg-grey-2"},{default:d(()=>[o(p,{flat:"",bordered:"",class:"q-mb-md"},{default:d(()=>[o(x,{class:"row q-col-gutter-sm items-end"},{default:d(()=>[s("div",A,[o(w,{modelValue:t.filters.from,"onUpdate:modelValue":e[0]||(e[0]=i=>t.filters.from=i),type:"date",label:"Desde",dense:"",outlined:""},null,8,["modelValue"])]),s("div",H,[o(w,{modelValue:t.filters.to,"onUpdate:modelValue":e[1]||(e[1]=i=>t.filters.to=i),type:"date",label:"Hasta",dense:"",outlined:""},null,8,["modelValue"])]),s("div",j,[a.$store.user?.role=="Administrador"?(h(),v(V,{key:0,modelValue:t.filters.area,"onUpdate:modelValue":e[2]||(e[2]=i=>t.filters.area=i),options:t.filterOptions.areas,label:"Área",dense:"",outlined:"",clearable:""},null,8,["modelValue","options"])):C("",!0)]),s("div",B,[o(y,{color:"primary",icon:"search",label:"Filtrar","no-caps":"",loading:t.loading,onClick:n.fetchDashboard},null,8,["loading","onClick"])])]),_:1})]),_:1}),s("div",U,[(h(!0),T(F,null,E(n.cards,i=>(h(),T("div",{class:"col-12 col-sm-4",key:i.key},[o(p,{flat:"",bordered:"",class:"q-pa-md text-center"},{default:d(()=>[s("div",R,u(i.label),1),s("div",Z,u(i.value??"—"),1),s("div",G,u(n.rangoTexto),1)]),_:2},1024)]))),128))]),s("div",X,[s("div",J,[o(p,{flat:"",bordered:"",class:"q-pa-md"},{default:d(()=>[e[6]||(e[6]=s("div",{class:"text-subtitle2 q-mb-sm"}," DNA / SLIM: Hechos de fragancia vs denuncia ",-1)),o(c,{type:"donut",height:"260",options:n.getDonutOptions("DNA / SLIM: fragancia vs denuncia",t.porFragancia.labels,"fragancia"),series:t.porFragancia.data},null,8,["options","series"])]),_:1})]),s("div",K,[o(p,{flat:"",bordered:"",class:"q-pa-md"},{default:d(()=>[e[7]||(e[7]=s("div",{class:"text-subtitle2 q-mb-sm"},"Casos por tipo (click para ver detalle)",-1)),o(c,{type:"donut",height:"260",options:n.getDonutOptions("Casos por tipo",t.porTipo.labels,"tipo"),series:t.porTipo.data},null,8,["options","series"])]),_:1})]),s("div",$,[o(p,{flat:"",bordered:"",class:"q-pa-md"},{default:d(()=>[e[8]||(e[8]=s("div",{class:"text-subtitle2 q-mb-sm"},"Casos por tipología (click para ver detalle)",-1)),o(c,{type:"donut",height:"260",options:n.getDonutOptions("Casos por tipología",t.porTipologia.labels,"tipologia"),series:t.porTipologia.data},null,8,["options","series"])]),_:1})])]),s("div",ee,[s("div",ae,[o(p,{flat:"",bordered:"",class:"q-pa-md"},{default:d(()=>[e[9]||(e[9]=s("div",{class:"text-subtitle2 q-mb-sm"},"Casos por rango de edad (denunciante)",-1)),o(c,{type:"bar",height:"300",options:n.barEdadOptions,series:n.barEdadSeries},null,8,["options","series"])]),_:1})]),s("div",te,[o(p,{flat:"",bordered:"",class:"q-pa-md"},{default:d(()=>[e[10]||(e[10]=s("div",{class:"text-subtitle2 q-mb-sm"},"Casos por mes",-1)),o(c,{type:"area",height:"300",options:n.areaOptions,series:n.areaSeries},null,8,["options","series"])]),_:1})])]),t.detalle.rows.length?(h(),v(p,{key:0,flat:"",bordered:"",class:"q-mt-md"},{default:d(()=>[o(x,{class:"row items-center justify-between"},{default:d(()=>[s("div",null,[s("div",oe,u(t.detalle.titulo),1),s("div",se," Total: "+u(t.detalle.rows.length)+" registro(s) ",1)]),o(y,{dense:"",flat:"",icon:"print",round:"",onClick:e[3]||(e[3]=i=>n.imprimirDetalle())}),o(y,{dense:"",flat:"",icon:"close",round:"",onClick:e[4]||(e[4]=i=>t.detalle.rows=[])})]),_:1}),o(O),o(x,null,{default:d(()=>[o(M,{rows:t.detalle.rows,columns:t.detalleColumns,"row-key":"id",dense:"",flat:"",bordered:"",loading:t.detalle.loading,"no-data-label":"Sin casos para mostrar",onRowClick:e[5]||(e[5]=(i,m,D)=>{this.$router.push("/casos/"+m.id)})},{"body-cell-caso_fecha_hecho":d(i=>[o(z,{props:i},{default:d(()=>[Q(u(n.formatDate(i.row.caso_fecha_hecho)),1)]),_:2},1032,["props"])]),_:1},8,["rows","columns","loading"])]),_:1})]),_:1})):C("",!0)]),_:1})}const De=S(L,[["render",le]]);export{De as default};
