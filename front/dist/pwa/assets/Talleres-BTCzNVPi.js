import{_ as w,Y as N,c as v,o as _,w as d,b as n,a as l,f as u,Q as C,e as f,h as I,d as x,t as g,a3 as D,a6 as m,a9 as y,Z as E,aa as q,ab as A,a8 as T,W as L,$ as O}from"./index-BP3Sy_Vn.js";import{Q as R}from"./QSpace-C9gxMyir.js";import{Q as h}from"./QSelect-b2PhM9eS.js";import{Q as b,b as k,c as V}from"./QMenu-DlV7zFtQ.js";import{Q}from"./QPage-CaKVPTrr.js";import{C as P}from"./ClosePopup-Rv2ssJwT.js";import{F as U,l as F,i as M,a as z,b as B}from"./es-B7rdg38q.js";import"./QItemLabel-DN-kSOpd.js";import"./format-Dgr2a6c2.js";const $={name:"TalleresCalendar",components:{FullCalendar:U},data(){return{dialog:{open:!1,isEdit:!1,currentId:null},solicitadoOpts:["DIRECTOR","SECRETARIA","PERSONAL UE"],colorOptions:[{label:"Azul",value:"#1976D2"},{label:"Verde",value:"#2E7D32"},{label:"Naranja",value:"#FB8C00"},{label:"Rojo",value:"#C62828"},{label:"Morado",value:"#6A1B9A"},{label:"Turquesa",value:"#0097A7"},{label:"Rosa",value:"#C2185B"}],form:{solicitado:null,fecha_inicio:"",fecha_final:"",colegio:"",curso:"",numero_asistentes:0,tema:"",descripcion:"",dirigido_a:"",color:"#1976D2"},saving:!1,deleting:!1,calendarOptions:{plugins:[M,z,B],locale:F,timeZone:"local",initialView:"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},slotMinTime:"06:00:00",slotMaxTime:"22:00:00",selectable:!0,editable:!0,eventOverlap:!1,events:(e,t,s)=>this.fetchEvents(e,t,s),select:e=>this.handleSelect(e),eventClick:e=>this.handleEventClick(e),eventDrop:e=>this.handleEventDrop(e),eventResize:e=>this.handleEventResize(e),eventDisplay:"block",nowIndicator:!0,height:"auto"}}},methods:{textColor(e){},req(e){return!!e||"Requerido"},reqNumber(e){return e===0||e==="0"?!0:!!e&&Number(e)>=0||"Número válido"},toApiLocal(e){return e?(e.length===16?`${e}:00`:e).replace("T"," "):null},toLocalInputValue(e){return(e||"").slice(0,16)},dateToLocalString(e){const t=e instanceof Date?e:new Date(e),s=S=>String(S).padStart(2,"0"),c=t.getFullYear(),i=s(t.getMonth()+1),r=s(t.getDate()),a=s(t.getHours()),o=s(t.getMinutes()),p=s(t.getSeconds());return`${c}-${i}-${r} ${a}:${o}:${p}`},async fetchEvents(e,t,s){try{const c=new URLSearchParams;c.set("start",e.startStr.slice(0,19)),c.set("end",e.endStr.slice(0,19));const{data:i}=await this.$axios.get(`/talleres?${c.toString()}`),r=i.map(a=>{const o=a.color||"#1976D2";return{id:a.id,title:`${a.colegio||"Taller"} - ${a.tema||"Sin tema"}`,start:a.fecha_inicio,end:a.fecha_final,backgroundColor:o,borderColor:o,textColor:this.textColor(o),extendedProps:{solicitado:a.solicitado,colegio:a.colegio,curso:a.curso,numero_asistentes:a.numero_asistentes,tema:a.tema,descripcion:a.descripcion,dirigido_a:a.dirigido_a,color:a.color}}});t(r)}catch(c){this.$q.notify({type:"negative",message:"No se pudo cargar los talleres"}),s(c)}},clearForm(){this.form={solicitado:null,fecha_inicio:"",fecha_final:"",colegio:"",curso:"",numero_asistentes:0,tema:"",descripcion:"",dirigido_a:"",color:"#1976D2"}},openCreate(e,t){this.clearForm(),this.dialog.isEdit=!1,this.dialog.currentId=null,this.form.fecha_inicio=this.toLocalInputValue(e),this.form.fecha_final=t?this.toLocalInputValue(t):"",this.dialog.open=!0},openEdit(e){this.clearForm(),this.dialog.isEdit=!0,this.dialog.currentId=e.id;const t=e.extendedProps;this.form.solicitado=t.solicitado,this.form.fecha_inicio=this.toLocalInputValue(e.startStr),this.form.fecha_final=e.endStr?this.toLocalInputValue(e.endStr):"",this.form.colegio=t.colegio||"",this.form.curso=t.curso||"",this.form.numero_asistentes=t.numero_asistentes||0,this.form.tema=t.tema||"",this.form.descripcion=t.descripcion||"",this.form.dirigido_a=t.dirigido_a||"",this.form.color=t.color||"#1976D2",this.dialog.open=!0},handleSelect(e){this.openCreate(e.startStr,e.endStr)},handleEventClick(e){this.openEdit(e.event)},async handleEventDrop(e){try{await this.$axios.put(`/talleres/${e.event.id}`,{fecha_inicio:this.dateToLocalString(e.event.start),fecha_final:e.event.end?this.dateToLocalString(e.event.end):null}),this.$q.notify({type:"positive",message:"Taller reprogramado"}),await this.refetch()}catch{e.revert(),this.$q.notify({type:"negative",message:"No se pudo reprogramar"})}},async handleEventResize(e){try{await this.$axios.put(`/talleres/${e.event.id}`,{fecha_final:e.event.end?this.dateToLocalString(e.event.end):null}),this.$q.notify({type:"positive",message:"Duración actualizada"}),await this.refetch()}catch{e.revert(),this.$q.notify({type:"negative",message:"No se pudo actualizar la duración"})}},async saveEvent(){if(!this.form.solicitado||!this.form.fecha_inicio||this.form.numero_asistentes===null){this.$q.notify({type:"warning",message:"Completa los campos obligatorios"});return}this.saving=!0;try{const e={...this.form};e.fecha_inicio=this.toApiLocal(this.form.fecha_inicio),e.fecha_final=this.form.fecha_final?this.toApiLocal(this.form.fecha_final):null,this.dialog.isEdit&&this.dialog.currentId?(await this.$axios.put(`/talleres/${this.dialog.currentId}`,e),this.$q.notify({type:"positive",message:"Taller actualizado"})):(await this.$axios.post("/talleres",e),this.$q.notify({type:"positive",message:"Taller creado"})),this.dialog.open=!1,await this.refetch()}catch(e){this.$q.notify({type:"negative",message:e?.response?.data?.message||"Error al guardar"})}finally{this.saving=!1}},async deleteEvent(){this.dialog.currentId&&this.$q.dialog({title:"Confirmar",message:"¿Eliminar este taller?",cancel:!0,persistent:!0}).onOk(async()=>{this.deleting=!0;try{await this.$axios.delete(`/talleres/${this.dialog.currentId}`),this.$q.notify({type:"warning",message:"Taller eliminado"}),this.dialog.open=!1,await this.refetch()}catch{this.$q.notify({type:"negative",message:"No se pudo eliminar"})}finally{this.deleting=!1}})},async refetch(){const e=this.$refs.calendar?.getApi?.();e&&e.refetchEvents()},imprimir(){const e=this.$refs.calendar.getApi().view.currentStart,t=this.$refs.calendar.getApi().view.currentEnd,s=new URLSearchParams;s.set("start",this.dateToLocalString(e)),s.set("end",this.dateToLocalString(t));const c=`/talleres/print?${s.toString()}`;window.open(this.$axios.defaults.baseURL+c,"_blank")},openCreateForNow(){const e=new Date,t=p=>String(p).padStart(2,"0"),s=e.getFullYear(),c=t(e.getMonth()+1),i=t(e.getDate()),r=t(e.getHours()),a=t(e.getMinutes()),o=`${s}-${c}-${i}T${r}:${a}`;this.openCreate(o,"")}}},G={class:"row items-center q-mb-md"},H={class:"col-auto"},Y={class:"text-subtitle1 text-weight-medium"},W={class:"row q-col-gutter-sm"},Z={class:"col-6"},j={class:"col-6"},J={class:"row q-col-gutter-sm"},K={class:"col-6"},X={class:"col-6"},ee={class:"row q-col-gutter-sm"},te={class:"col-6"},oe={class:"col-6"};function ie(e,t,s,c,i,r){const a=N("FullCalendar");return _(),v(Q,{class:"q-pa-md bg-grey-2"},{default:d(()=>[n("div",G,[t[11]||(t[11]=n("div",{class:"col"},[n("div",{class:"text-h6 text-weight-bold"},"Talleres"),n("div",{class:"text-caption text-grey-7"},"Gestión en calendario")],-1)),n("div",H,[l(u,{flat:"",icon:"print",class:"q-mr-sm",onClick:r.imprimir},null,8,["onClick"]),l(u,{color:"primary",icon:"add_circle",label:"Nuevo Taller",onClick:r.openCreateForNow,"no-caps":""},null,8,["onClick"]),l(u,{flat:"",icon:"refresh",class:"q-ml-sm",onClick:r.refetch},null,8,["onClick"])])]),l(C,{flat:"",bordered:"",class:"section-card"},{default:d(()=>[l(f,null,{default:d(()=>[l(a,{ref:"calendar",options:i.calendarOptions},null,8,["options"])]),_:1})]),_:1}),l(I,{modelValue:i.dialog.open,"onUpdate:modelValue":t[10]||(t[10]=o=>i.dialog.open=o),persistent:""},{default:d(()=>[l(C,{style:{"min-width":"500px","max-width":"700px"}},{default:d(()=>[l(f,{class:"row items-center q-gutter-sm"},{default:d(()=>[l(x,{name:"workshop"}),n("div",Y,g(i.dialog.isEdit?"Editar Taller":"Nuevo Taller"),1),l(R)]),_:1}),l(D),l(f,{class:"q-gutter-md"},{default:d(()=>[l(h,{modelValue:i.form.solicitado,"onUpdate:modelValue":t[0]||(t[0]=o=>i.form.solicitado=o),options:i.solicitadoOpts,label:"Solicitado *",dense:"",outlined:"",rules:[r.req]},null,8,["modelValue","options","rules"]),n("div",W,[n("div",Z,[l(m,{modelValue:i.form.fecha_inicio,"onUpdate:modelValue":t[1]||(t[1]=o=>i.form.fecha_inicio=o),type:"datetime-local",label:"Fecha inicio *",dense:"",outlined:"",rules:[r.req]},null,8,["modelValue","rules"])]),n("div",j,[l(m,{modelValue:i.form.fecha_final,"onUpdate:modelValue":t[2]||(t[2]=o=>i.form.fecha_final=o),type:"datetime-local",label:"Fecha final",dense:"",outlined:""},null,8,["modelValue"])])]),n("div",J,[n("div",K,[l(m,{modelValue:i.form.colegio,"onUpdate:modelValue":t[3]||(t[3]=o=>i.form.colegio=o),label:"Colegio",dense:"",outlined:""},null,8,["modelValue"])]),n("div",X,[l(m,{modelValue:i.form.curso,"onUpdate:modelValue":t[4]||(t[4]=o=>i.form.curso=o),label:"Curso",dense:"",outlined:""},null,8,["modelValue"])])]),n("div",ee,[n("div",te,[l(m,{modelValue:i.form.numero_asistentes,"onUpdate:modelValue":t[5]||(t[5]=o=>i.form.numero_asistentes=o),modelModifiers:{number:!0},type:"number",min:"0",label:"Nº asistentes *",dense:"",outlined:"",rules:[r.reqNumber]},null,8,["modelValue","rules"])]),n("div",oe,[l(h,{modelValue:i.form.dirigido_a,"onUpdate:modelValue":t[6]||(t[6]=o=>i.form.dirigido_a=o),options:["ESTUDIANTE","PADRES DE FAMILIA","PROFESORES/PERSONAL UE"],label:"Dirigido a",dense:"",outlined:""},null,8,["modelValue"])])]),l(h,{modelValue:i.form.tema,"onUpdate:modelValue":t[7]||(t[7]=o=>i.form.tema=o),options:["PREVENCION DE ALCOHOLIMO","PREVENCION DE ALCOHOLIMO Y DROGADICCION","PREVENCION DE VIOLENCIA (BULLING)","PREVENCION DE EMBARAZON NNA","PRIMERA INFANCIA"],label:"Tema",dense:"",outlined:""},null,8,["modelValue"]),l(m,{modelValue:i.form.descripcion,"onUpdate:modelValue":t[8]||(t[8]=o=>i.form.descripcion=o),type:"textarea",autogrow:"",label:"Descripción",dense:"",outlined:""},null,8,["modelValue"]),l(h,{modelValue:i.form.color,"onUpdate:modelValue":t[9]||(t[9]=o=>i.form.color=o),options:i.colorOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",dense:"",outlined:"",clearable:"",label:"Color del taller"},{option:d(o=>[l(k,q(A(o.itemProps)),{default:d(()=>[l(V,{avatar:""},{default:d(()=>[l(b,{square:"",style:y({background:o.opt.value,color:r.textColor(o.opt.value)})},null,8,["style"])]),_:2},1024),l(V,null,{default:d(()=>[E(g(o.opt.label),1)]),_:2},1024)]),_:2},1040)]),"selected-item":d(o=>[l(b,{square:"",style:y({background:o.opt,color:r.textColor(o.opt)}),size:"sm"},{default:d(()=>[E(g((i.colorOptions.find(p=>p.value===o.opt)||{}).label||"Color"),1)]),_:2},1032,["style"])]),_:1},8,["modelValue","options"])]),_:1}),l(T,{align:"right"},{default:d(()=>[L(l(u,{flat:"",label:"Cancelar"},null,512),[[P]]),l(u,{color:"primary",label:i.dialog.isEdit?"Actualizar":"Crear",loading:i.saving,onClick:r.saveEvent},null,8,["label","loading","onClick"]),i.dialog.isEdit?(_(),v(u,{key:0,flat:"",color:"negative",label:"Eliminar",loading:i.deleting,onClick:r.deleteEvent},null,8,["loading","onClick"])):O("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const pe=w($,[["render",ie],["__scopeId","data-v-a0e91ae6"]]);export{pe as default};
