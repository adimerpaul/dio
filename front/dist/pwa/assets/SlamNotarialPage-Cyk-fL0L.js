import{_ as S,c as p,o as m,w as s,b as a,a as i,a6 as c,d as y,f as u,a0 as _,$ as k,a1 as F,a2 as M,V as Y,Z as b,a4 as w,t as h,h as Q,Q as A,e as D}from"./index-tEaV_suc.js";import{Q as V,a as g}from"./QItem-BFEJhtlp.js";import{Q as N}from"./QList-BY-ybt9S.js";import{Q as U}from"./QBtnDropdown-DsweSKwP.js";import{Q as E}from"./QBadge-CFDHE5lk.js";import{Q as I}from"./QMarkupTable-C0DQYA4_.js";import{Q as O}from"./QSpace-BBiF7Ypc.js";import{Q as L}from"./QFile-BFn-aZ3N.js";import{Q as z}from"./QForm-Bx9oCgaa.js";import{Q as T}from"./QPage-CezfwX8s.js";import{h as r}from"./moment-C5S46NFB.js";import{E as C,a as x}from"./jspdf.plugin.autotable-YJs03axq.js";import"./QBtnGroup-CYewFwof.js";import"./QMenu-MF9hz9C1.js";import"./position-engine-BS4hZsDu.js";import"./QChip-wb55BxGN.js";import"./format-CJebrXOQ.js";const R={name:"SlamNotarialPage",data(){return{loading:!1,filter:"",start:r().startOf("week").add(1,"day").format("YYYY-MM-DD"),end:r().endOf("week").add(1,"day").format("YYYY-MM-DD"),rows:[],dialog:!1,file:null,form:this.emptyForm()}},computed:{filteredRows(){if(!this.filter)return this.rows;const t=this.filter.toLowerCase();return this.rows.filter(e=>(e.nombre_completo||"").toLowerCase().includes(t)||(e.ci||"").toLowerCase().includes(t)||(e.estado_civil||"").toLowerCase().includes(t)||(e.ocupacion||"").toLowerCase().includes(t)||String(e.fecha||"").toLowerCase().includes(t))}},mounted(){this.fetch()},methods:{fmtFechaSolo(t){return t?r(t).isValid()?r(t).format("YYYY-MM-DD"):String(t):"—"},fmtFecha(t){return t?r(t).isValid()?r(t).format("YYYY-MM-DD HH:mm"):String(t):"—"},emptyForm(){return{id:null,fecha:r().format("YYYY-MM-DD"),nombre_completo:"",edad:"",fecha_nacimiento:"",estado_civil:"",ci:"",grado_instruccion:"",ocupacion:"",direccion_domicilio:"",url:null}},edadCalculate(){if(this.form.fecha_nacimiento){const t=r(this.form.fecha_nacimiento,"YYYY-MM-DD"),e=r();this.form.edad=e.diff(t,"years")}else this.form.edad=""},setThisWeek(){this.start=r().startOf("week").add(1,"day").format("YYYY-MM-DD"),this.end=r().endOf("week").add(1,"day").format("YYYY-MM-DD"),this.fetch()},setWeekend(){const t=r().startOf("week").add(6,"day"),e=r().startOf("week").add(7,"day");this.start=t.format("YYYY-MM-DD"),this.end=e.format("YYYY-MM-DD"),this.fetch()},async fetch(){this.loading=!0;try{const t={};this.start&&this.end&&(t.start=this.start,t.end=this.end);const{data:e}=await this.$axios.get("slam-notariales",{params:t});this.rows=e}catch(t){this.$alert?.error(t.response?.data?.message||"Error cargando registros")}finally{this.loading=!1}},openNew(){this.dialog=!0,this.file=null,this.form=this.emptyForm()},openEdit(t){this.dialog=!0,this.file=null,this.form={...this.emptyForm(),...t}},async save(){this.loading=!0;try{const t=new FormData;["fecha","nombre_completo","edad","fecha_nacimiento","estado_civil","ci","grado_instruccion","ocupacion","direccion_domicilio"].forEach(n=>t.append(n,this.form[n]??"")),this.file&&t.append("url",this.file),this.form.id?await this.$axios.put(`slam-notariales/${this.form.id}`,t,{headers:{"Content-Type":"multipart/form-data"}}):await this.$axios.post("slam-notariales",t,{headers:{"Content-Type":"multipart/form-data"}}),this.dialog=!1,this.$alert?.success("Guardado"),this.fetch()}catch(t){this.$alert?.error(t.response?.data?.message||"No se pudo guardar")}finally{this.loading=!1}},onDelete(t){this.$alert?.dialog("¿Eliminar registro?").onOk(async()=>{this.loading=!0;try{await this.$axios.delete(`slam-notariales/${t}`),this.$alert?.success("Eliminado"),this.fetch()}catch(e){this.$alert?.error(e.response?.data?.message||"No se pudo eliminar")}finally{this.loading=!1}})},storageUrl(t){const e=String(t||"").replace(/^\/+/,"");return`${this.$url}/../storage/${e}`},async fetchImageAsDataUrl(t){const e=this.storageUrl(t);try{const f=(await this.$axios.get(e,{responseType:"blob"})).data;return await new Promise((l,d)=>{const o=new FileReader;o.onload=()=>l(o.result),o.onerror=d,o.readAsDataURL(f)})}catch{return null}},async printOne(t){const e=new C({unit:"mm",format:"a4"});if(e.setFontSize(14),e.text("SLAM NOTARIAL",105,14,{align:"center"}),e.setFontSize(10),e.text(`Fecha registro: ${this.fmtFecha(t.fecha)}`,14,22),x(e,{startY:26,theme:"grid",styles:{fontSize:9,cellPadding:2},head:[["Campo","Valor"]],body:[["Nombre completo",t.nombre_completo||"—"],["CI",t.ci||"—"],["Estado civil",t.estado_civil||"—"],["Fecha nacimiento",t.fecha_nacimiento||"—"],["Edad",(t.edad??"")!==""?String(t.edad):"—"],["Grado de instrucción",t.grado_instruccion||"—"],["Ocupación",t.ocupacion||"—"],["Dirección",t.direccion_domicilio||"—"]]}),t.url){const n=(e.lastAutoTable?.finalY||26)+8;e.setFontSize(10),e.text("Archivo adjunto:",14,n);const f=await this.fetchImageAsDataUrl(t.url);if(f)try{const l=String(f).startsWith("data:image/png");e.addImage(f,l?"PNG":"JPEG",14,n+4,60,45),e.setFontSize(8),e.text(this.storageUrl(t.url),14,n+54)}catch{e.setFontSize(9),e.text(`Ver: ${this.storageUrl(t.url)}`,14,n+6)}else e.setFontSize(9),e.text(`Ver: ${this.storageUrl(t.url)}`,14,n+6)}e.setFontSize(8),e.text(`Generado: ${r().format("YYYY-MM-DD HH:mm")}`,14,290),e.save(`slam-notarial-${t.id}.pdf`)},async printAll(){const t=this.filteredRows;if(!t.length){this.$alert?.error("No hay registros para imprimir");return}const e=new C({unit:"mm",format:"a4",orientation:"portrait"});e.setFontSize(14),e.text("SLAM NOTARIAL — LISTADO",105,14,{align:"center"}),e.setFontSize(10),e.text(`Rango: ${this.start||"—"} a ${this.end||"—"}`,14,22),e.text(`Total: ${t.length}`,160,22),x(e,{startY:26,theme:"grid",styles:{fontSize:8,cellPadding:2},head:[["#","Fecha","Nombre completo","CI","Estado civil","Ocupación","Archivo"]],body:t.map((n,f)=>[f+1,this.fmtFecha(n.fecha),n.nombre_completo||"",n.ci||"",n.estado_civil||"",n.ocupacion||"",n.url?"SI":"NO"])}),e.setFontSize(8),e.text(`Generado: ${r().format("YYYY-MM-DD HH:mm")}`,14,290),e.save(`slam-notarial-listado-${r().format("YYYYMMDD-HHmm")}.pdf`)}}},P={class:"row items-center q-gutter-sm q-mb-md"},q={class:"text-center"},B={key:0},G={class:"text-h6"},H={class:"row q-col-gutter-md"},W={class:"col-12 col-md-8"},K={class:"col-6 col-md-3"},j={class:"col-6 col-md-3"},J={class:"col-12 col-md-6"},Z={class:"col-6 col-md-3"},X={class:"col-6 col-md-3"},$={class:"col-12 col-md-6"},ee={class:"col-12"},te={class:"col-12"},oe={class:"row items-center"},le={class:"col"},ie={key:0,class:"col-auto"},ae={class:"text-right q-mt-md"};function se(t,e,n,f,l,d){return m(),p(T,{class:"q-pa-md"},{default:s(()=>[a("div",P,[i(c,{dense:"",outlined:"",modelValue:l.filter,"onUpdate:modelValue":e[0]||(e[0]=o=>l.filter=o),label:"Buscar",style:{"min-width":"220px"}},{append:s(()=>[i(y,{name:"search"})]),_:1},8,["modelValue"]),i(c,{dense:"",outlined:"",type:"date",modelValue:l.start,"onUpdate:modelValue":e[1]||(e[1]=o=>l.start=o),label:"Inicio",style:{width:"150px"}},null,8,["modelValue"]),i(c,{dense:"",outlined:"",type:"date",modelValue:l.end,"onUpdate:modelValue":e[2]||(e[2]=o=>l.end=o),label:"Fin",style:{width:"150px"}},null,8,["modelValue"]),i(u,{dense:"",outline:"",color:"primary",label:"Esta semana",onClick:d.setThisWeek},null,8,["onClick"]),i(u,{dense:"",outline:"",color:"indigo",label:"Fin de semana",onClick:d.setWeekend},null,8,["onClick"]),i(u,{color:"primary",icon:"refresh",label:"Actualizar","no-caps":"",loading:l.loading,onClick:d.fetch},null,8,["loading","onClick"]),i(u,{color:"positive",icon:"add_circle_outline",label:"Nuevo","no-caps":"",loading:l.loading,onClick:d.openNew},null,8,["loading","onClick"]),i(u,{color:"grey-8",icon:"print",label:"Imprimir todo","no-caps":"",loading:l.loading,onClick:d.printAll},null,8,["loading","onClick"])]),i(I,{flat:"",bordered:"",dense:"","wrap-cells":""},{default:s(()=>[e[21]||(e[21]=a("thead",null,[a("tr",null,[a("th",{class:"text-center"},"Acciones"),a("th",{class:"text-left"},"Fecha"),a("th",{class:"text-left"},"Nombre"),a("th",{class:"text-left"},"CI"),a("th",{class:"text-left"},"Estado civil"),a("th",{class:"text-left"},"Ocupación"),a("th",{class:"text-left"},"Archivo")])],-1)),a("tbody",null,[(m(!0),_(F,null,M(d.filteredRows,o=>(m(),_("tr",{key:o.id},[a("td",q,[i(U,{label:"Acciones",dense:"","no-caps":"",size:"10px",color:"primary"},{default:s(()=>[i(N,null,{default:s(()=>[Y((m(),p(V,{clickable:"",onClick:v=>d.openEdit(o)},{default:s(()=>[i(g,{avatar:""},{default:s(()=>[i(y,{name:"edit"})]),_:1}),i(g,null,{default:s(()=>e[16]||(e[16]=[b("Editar")])),_:1})]),_:2},1032,["onClick"])),[[w]]),Y((m(),p(V,{clickable:"",onClick:v=>d.printOne(o)},{default:s(()=>[i(g,{avatar:""},{default:s(()=>[i(y,{name:"print"})]),_:1}),i(g,null,{default:s(()=>e[17]||(e[17]=[b("Impresiones")])),_:1})]),_:2},1032,["onClick"])),[[w]]),Y((m(),p(V,{clickable:"",onClick:v=>d.onDelete(o.id)},{default:s(()=>[i(g,{avatar:""},{default:s(()=>[i(y,{name:"delete"})]),_:1}),i(g,null,{default:s(()=>e[18]||(e[18]=[b("Eliminar")])),_:1})]),_:2},1032,["onClick"])),[[w]])]),_:2},1024)]),_:2},1024)]),a("td",null,h(d.fmtFechaSolo(o.fecha)),1),a("td",null,h(o.nombre_completo),1),a("td",null,h(o.ci),1),a("td",null,h(o.estado_civil),1),a("td",null,h(o.ocupacion),1),a("td",null,[o.url?(m(),p(u,{key:0,dense:"",outline:"",icon:"attach_file",label:"Archivo",href:`${t.$url}/../storage/${o.url}`,target:"_blank"},null,8,["href"])):(m(),p(E,{key:1,color:"grey-5",outline:""},{default:s(()=>e[19]||(e[19]=[b("—")])),_:1}))])]))),128)),d.filteredRows.length?k("",!0):(m(),_("tr",B,e[20]||(e[20]=[a("td",{colspan:"7",class:"text-center text-grey"},"Sin registros",-1)])))])]),_:1}),i(Q,{modelValue:l.dialog,"onUpdate:modelValue":e[15]||(e[15]=o=>l.dialog=o),persistent:""},{default:s(()=>[i(A,{style:{width:"720px","max-width":"95vw"}},{default:s(()=>[i(D,{class:"row items-center q-pb-none"},{default:s(()=>[a("div",G,h(l.form.id?"Editar":"Nuevo")+" SLAM Notarial",1),i(O),i(u,{flat:"",round:"",dense:"",icon:"close",onClick:e[3]||(e[3]=o=>l.dialog=!1)})]),_:1}),i(D,{class:"q-pt-none"},{default:s(()=>[i(z,{onSubmit:d.save},{default:s(()=>[a("div",H,[a("div",W,[i(c,{dense:"",outlined:"",modelValue:l.form.nombre_completo,"onUpdate:modelValue":e[4]||(e[4]=o=>l.form.nombre_completo=o),label:"Nombre completo"},null,8,["modelValue"])]),a("div",K,[i(c,{dense:"",outlined:"",type:"date",modelValue:l.form.fecha_nacimiento,"onUpdate:modelValue":[e[5]||(e[5]=o=>l.form.fecha_nacimiento=o),e[6]||(e[6]=o=>d.edadCalculate())],label:"F. nacimiento"},null,8,["modelValue"])]),a("div",j,[i(c,{dense:"",outlined:"",modelValue:l.form.edad,"onUpdate:modelValue":e[7]||(e[7]=o=>l.form.edad=o),label:"Edad"},null,8,["modelValue"])]),a("div",J,[i(c,{dense:"",outlined:"",modelValue:l.form.estado_civil,"onUpdate:modelValue":e[8]||(e[8]=o=>l.form.estado_civil=o),label:"Estado civil"},null,8,["modelValue"])]),a("div",Z,[i(c,{dense:"",outlined:"",modelValue:l.form.ci,"onUpdate:modelValue":e[9]||(e[9]=o=>l.form.ci=o),label:"CI"},null,8,["modelValue"])]),a("div",X,[i(c,{dense:"",outlined:"",modelValue:l.form.grado_instruccion,"onUpdate:modelValue":e[10]||(e[10]=o=>l.form.grado_instruccion=o),label:"Grado de instr."},null,8,["modelValue"])]),a("div",$,[i(c,{dense:"",outlined:"",modelValue:l.form.ocupacion,"onUpdate:modelValue":e[11]||(e[11]=o=>l.form.ocupacion=o),label:"Ocupación"},null,8,["modelValue"])]),a("div",ee,[i(c,{dense:"",outlined:"",modelValue:l.form.direccion_domicilio,"onUpdate:modelValue":e[12]||(e[12]=o=>l.form.direccion_domicilio=o),label:"Dirección"},null,8,["modelValue"])]),a("div",te,[a("div",oe,[a("div",le,[i(L,{modelValue:l.file,"onUpdate:modelValue":e[13]||(e[13]=o=>l.file=o),dense:"",outlined:"",label:"Archivo (url)"},null,8,["modelValue"])]),l.form.url?(m(),_("div",ie,[i(u,{dense:"",outline:"",icon:"open_in_new",label:"Ver actual",href:`${t.$url}/../storage/${l.form.url}`,target:"_blank"},null,8,["href"])])):k("",!0)])])]),a("div",ae,[i(u,{color:"negative",flat:"",label:"Cancelar",onClick:e[14]||(e[14]=o=>l.dialog=!1),loading:l.loading},null,8,["loading"]),i(u,{color:"primary",label:"Guardar",type:"submit",class:"q-ml-sm",loading:l.loading},null,8,["loading"])])]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ke=S(R,[["render",se]]);export{ke as default};
