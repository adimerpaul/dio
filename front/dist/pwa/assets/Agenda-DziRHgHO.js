import{Q as y}from"./QSelect-c6bTY1Yw.js";import{_ as k,Y as q,c as v,o as C,w as d,b as u,a as l,f as m,Q as b,e as g,h as A,d as I,t as f,a3 as F,a6 as h,ac as P,a9 as x,Z as w,aa as z,ab as Q,a8 as L,V as $,$ as N}from"./index-07_X1hqC.js";import{Q as T}from"./QSpace-DwvuL4jz.js";import{Q as _}from"./QMenu-DTWjuNzv.js";import{Q as O,a as V}from"./QItem-DnWPKqFP.js";import{Q as U}from"./QPage-CYp8txeq.js";import{C as M}from"./ClosePopup-YNzNHQDw.js";import{F as R,l as W,i as B,a as G,b as Y}from"./es-BdDLsU-q.js";import{E as j,a as H}from"./jspdf.plugin.autotable-DULnAugq.js";import"./QItemLabel-Dj13st_M.js";import"./format-CJebrXOQ.js";import"./position-engine-B5Gd_Ixr.js";const Z={name:"Agenda",components:{FullCalendar:R},data(){return{statusOptions:["Programado","Reprogramado","Atendido","Cancelado"],filters:{status:null,user_id:null},dialog:{open:!1,isEdit:!1,currentId:null},colorOptions:[{label:"Azul",value:"#1976D2"},{label:"Naranja",value:"#FB8C00"},{label:"Verde",value:"#2E7D32"},{label:"Rojo",value:"#C62828"},{label:"Gris",value:"#546E7A"},{label:"Morado",value:"#6A1B9A"},{label:"Cian",value:"#0097A7"}],form:{title:"",start:"",end:"",all_day:!1,status:"Programado",location:"",notes:"",caso_id:null,color:null},originalWhen:{start:null,end:null},saving:!1,deleting:!1,eventsCache:[],calendarOptions:{plugins:[B,G,Y],locale:W,timeZone:"local",initialView:"timeGridWeek",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},slotMinTime:"08:00:00",slotMaxTime:"20:00:00",selectable:!0,editable:!0,eventOverlap:!0,events:(t,e,i)=>this.fetchEvents(t,e,i),select:t=>this.handleSelect(t),eventClick:t=>this.handleEventClick(t),eventDrop:t=>this.handleEventDrop(t),eventResize:t=>this.handleEventResize(t),eventDisplay:"block",nowIndicator:!0,height:"auto"}}},methods:{normalizeColor(t){if(!t)return null;if(typeof t!="string"&&(t=String(t).trim()),/^#[0-9A-Fa-f]{3}$/.test(t)){const e=t[1],i=t[2],s=t[3];return`#${e}${e}${i}${i}${s}${s}`}return/^#[0-9A-Fa-f]{6}$/.test(t)?t:null},textColor(t){const e=this.normalizeColor(t);if(!e)return"white";const i=e.slice(1),s=parseInt(i.slice(0,2),16),a=parseInt(i.slice(2,4),16),n=parseInt(i.slice(4,6),16);return .299*s+.587*a+.114*n>150?"black":"white"},toApiLocal(t){return t?(t.length===16?`${t}:00`:t).replace("T"," "):null},dateToLocalString(t){const e=t instanceof Date?t:new Date(t),i=p=>String(p).padStart(2,"0"),s=e.getFullYear(),a=i(e.getMonth()+1),n=i(e.getDate()),r=i(e.getHours()),o=i(e.getMinutes()),c=i(e.getSeconds());return`${s}-${a}-${n} ${r}:${o}:${c}`},req(t){return!!t||"Requerido"},async fetchEvents(t,e,i){try{const s=new URLSearchParams;s.set("start",t.startStr.slice(0,19)),s.set("end",t.endStr.slice(0,19)),this.filters.status&&s.set("status",this.filters.status),this.filters.user_id&&s.set("user_id",this.filters.user_id);const{data:a}=await this.$axios.get(`/agendas?${s.toString()}`),n=a.map(r=>{const o=this.normalizeColor(r.color)||this.colorFor(r);return{id:r.id,title:r.title,start:r.start,end:r.end,allDay:!!r.all_day,backgroundColor:o,borderColor:o,textColor:this.textColor(o),extendedProps:{status:r.status,notes:r.notes,location:r.location,caso_id:r.caso_id,color:this.normalizeColor(r.color)}}});this.eventsCache=n,e(n)}catch(s){this.$q.notify({type:"negative",message:"No se pudo cargar la agenda"}),i(s)}},colorFor(t){if(t.color)return t.color;switch(t.status){case"Programado":return"#1976D2";case"Reprogramado":return"#FB8C00";case"Atendido":return"#2E7D32";case"Cancelado":return"#C62828";default:return"#546E7A"}},clearForm(){this.form={title:"",start:"",end:"",all_day:!1,status:"Programado",location:"",notes:"",caso_id:null,color:null},this.originalWhen={start:null,end:null}},openCreate(t,e,i){this.clearForm(),this.dialog.isEdit=!1,this.dialog.currentId=null,this.form.start=this.toLocalInputValue(t),this.form.end=e?this.toLocalInputValue(e):"",this.form.all_day=!!i,this.originalWhen.start=this.form.start,this.originalWhen.end=this.form.end,this.dialog.open=!0},openEdit(t){this.clearForm(),this.dialog.isEdit=!0,this.dialog.currentId=t.id,this.form.title=t.title,this.form.start=this.toLocalInputValue(t.startStr),this.form.end=t.endStr?this.toLocalInputValue(t.endStr):"",this.form.all_day=t.allDay,this.form.status=t.extendedProps?.status||"Programado",this.form.location=t.extendedProps?.location||"",this.form.notes=t.extendedProps?.notes||"",this.form.caso_id=t.extendedProps?.caso_id||null,this.form.color=t.extendedProps?.color||null,this.originalWhen.start=this.form.start,this.originalWhen.end=this.form.end,this.dialog.open=!0},toLocalInputValue(t){return(t||"").slice(0,16)},handleSelect(t){this.openCreate(t.startStr,t.endStr,t.allDay)},handleEventClick(t){this.openEdit(t.event)},async handleEventDrop(t){try{await this.$axios.put(`/agendas/${t.event.id}`,{start:this.dateToLocalString(t.event.start),end:t.event.end?this.dateToLocalString(t.event.end):null}),this.$q.notify({type:"positive",message:"Cita reprogramada"}),await this.refetch()}catch{t.revert(),this.$q.notify({type:"negative",message:"No se pudo reprogramar"})}},async handleEventResize(t){try{await this.$axios.put(`/agendas/${t.event.id}`,{end:t.event.end?this.dateToLocalString(t.event.end):null}),this.$q.notify({type:"positive",message:"Duración actualizada"}),await this.refetch()}catch{t.revert(),this.$q.notify({type:"negative",message:"No se pudo actualizar la duración"})}},async saveEvent(){this.saving=!0;try{if(!this.form.title||!this.form.start){this.$q.notify({type:"negative",message:"Completa título e inicio"}),this.saving=!1;return}const t=this.dialog.isEdit&&this.dialog.currentId,e={title:this.form.title,all_day:this.form.all_day,status:this.form.status,location:this.form.location||null,notes:this.form.notes||null,caso_id:this.form.caso_id||null,color:this.form.color||null,start:this.toApiLocal(this.form.start),end:this.form.end?this.toApiLocal(this.form.end):null};t?(await this.$axios.put(`/agendas/${this.dialog.currentId}`,e),this.$q.notify({type:"positive",message:"Cita actualizada"})):(await this.$axios.post("/agendas",e),this.$q.notify({type:"positive",message:"Cita creada"})),this.dialog.open=!1,await this.refetch()}catch(t){this.$q.notify({type:"negative",message:t?.response?.data?.message||"No se pudo guardar la cita"})}finally{this.saving=!1}},async deleteEvent(){if(this.dialog.currentId){this.deleting=!0;try{await this.$axios.delete(`/agendas/${this.dialog.currentId}`),this.$q.notify({type:"warning",message:"Cita eliminada"}),this.dialog.open=!1,await this.refetch()}catch{this.$q.notify({type:"negative",message:"No se pudo eliminar"})}finally{this.deleting=!1}}},async refetch(){const t=this.$refs.calendar?.getApi?.();t&&t.refetchEvents()},openCreateForNow(){const t=new Date,e=D=>String(D).padStart(2,"0"),i=t.getFullYear(),s=e(t.getMonth()+1),a=e(t.getDate()),n=e(t.getHours()),r=e(t.getMinutes()),o=`${i}-${s}-${a}T${n}:${r}`,c=new Date(t.getTime()+30*6e4),p=e(c.getHours()),S=e(c.getMinutes()),E=`${i}-${s}-${a}T${p}:${S}`;this.openCreate(o,E,!1)},async exportPdf(){const t=this.eventsCache;if(!t.length){this.$q.notify({type:"warning",message:"No hay citas para exportar"});return}const e=new j;e.setFontSize(16),e.text("Agenda de Citas",14,20),e.setFontSize(10),e.text(`Fecha de exportación: ${new Date().toLocaleString()}`,14,28);const i=t.map(s=>[s.title,s.extendedProps?.status||"",s.start?new Date(s.start).toLocaleString():"",s.end?new Date(s.end).toLocaleString():"",s.extendedProps?.location||"",s.extendedProps?.caso_id||""]);H(e,{head:[["Título","Estado","Inicio","Fin","Lugar","Caso"]],body:i,startY:35,styles:{fontSize:9}}),e.save(`agenda-${new Date().toISOString().slice(0,10)}.pdf`)}}},J={class:"row items-center q-mb-md"},K={class:"col-16 col-md-6 row q-gutter-sm"},X={class:"text-subtitle1 text-weight-medium"},tt={class:"row q-col-gutter-sm"},et={class:"col-6"},at={class:"col-6"};function ot(t,e,i,s,a,n){const r=q("FullCalendar");return C(),v(U,{class:"q-pa-md bg-grey-2"},{default:d(()=>[u("div",J,[e[9]||(e[9]=u("div",{class:"col-16 col-md-6"},[u("div",{class:"text-h6 text-weight-bold"},"Agenda de Citas"),u("div",{class:"text-caption text-grey-7"},"Gestión de citas psicológicas")],-1)),u("div",K,[l(y,{modelValue:a.filters.status,"onUpdate:modelValue":e[0]||(e[0]=o=>a.filters.status=o),dense:"",outlined:"",clearable:"",label:"Estado",options:a.statusOptions,style:{width:"180px"},onInput:n.refetch},null,8,["modelValue","options","onInput"]),l(m,{color:"primary",icon:"event",label:"Nueva cita",onClick:n.openCreateForNow},null,8,["onClick"]),l(m,{flat:"",icon:"refresh",onClick:n.refetch},null,8,["onClick"]),l(m,{flat:"",icon:"picture_as_pdf",label:"PDF",color:"primary",onClick:n.exportPdf},null,8,["onClick"])])]),l(b,{flat:"",bordered:"",class:"section-card"},{default:d(()=>[l(g,null,{default:d(()=>[l(r,{ref:"calendar",options:a.calendarOptions},null,8,["options"])]),_:1})]),_:1}),l(A,{modelValue:a.dialog.open,"onUpdate:modelValue":e[8]||(e[8]=o=>a.dialog.open=o),persistent:""},{default:d(()=>[l(b,{style:{"min-width":"420px","max-width":"640px"}},{default:d(()=>[l(g,{class:"row items-center q-gutter-sm"},{default:d(()=>[l(I,{name:"event"}),u("div",X,f(a.dialog.isEdit?"Editar cita":"Nueva cita"),1),l(T)]),_:1}),l(F),l(g,{class:"q-gutter-md"},{default:d(()=>[l(h,{modelValue:a.form.title,"onUpdate:modelValue":e[1]||(e[1]=o=>a.form.title=o),dense:"",outlined:"",label:"Título *",rules:[n.req]},null,8,["modelValue","rules"]),u("div",tt,[u("div",et,[l(h,{modelValue:a.form.start,"onUpdate:modelValue":e[2]||(e[2]=o=>a.form.start=o),dense:"",outlined:"",type:"datetime-local",label:"Inicio *",rules:[n.req]},null,8,["modelValue","rules"])]),u("div",at,[l(h,{modelValue:a.form.end,"onUpdate:modelValue":e[3]||(e[3]=o=>a.form.end=o),dense:"",outlined:"",type:"datetime-local",label:"Fin"},null,8,["modelValue"])])]),l(P,{modelValue:a.form.all_day,"onUpdate:modelValue":e[4]||(e[4]=o=>a.form.all_day=o),label:"Todo el día"},null,8,["modelValue"]),l(y,{modelValue:a.form.color,"onUpdate:modelValue":e[5]||(e[5]=o=>a.form.color=o),options:a.colorOptions,"option-value":"value","option-label":"label","emit-value":"","map-options":"",dense:"",outlined:"",clearable:"",label:"Color de la cita"},{option:d(o=>[l(O,z(Q(o.itemProps)),{default:d(()=>[l(V,{avatar:""},{default:d(()=>[l(_,{square:"",style:x({background:n.normalizeColor(o.opt.value)||"#546E7A",color:n.textColor(n.normalizeColor(o.opt.value)||"#546E7A")})},null,8,["style"])]),_:2},1024),l(V,null,{default:d(()=>[w(f(o.opt.label),1)]),_:2},1024)]),_:2},1040)]),"selected-item":d(o=>[l(_,{square:"",style:x({background:n.normalizeColor(o.opt)||"#546E7A",color:n.textColor(n.normalizeColor(o.opt)||"#546E7A")}),size:"sm"},{default:d(()=>[w(f((a.colorOptions.find(c=>c.value===o.opt)||{}).label||"Color"),1)]),_:2},1032,["style"])]),_:1},8,["modelValue","options"]),l(h,{modelValue:a.form.caso_id,"onUpdate:modelValue":e[6]||(e[6]=o=>a.form.caso_id=o),dense:"",outlined:"",type:"number",label:"Caso (ID)"},null,8,["modelValue"]),l(h,{modelValue:a.form.notes,"onUpdate:modelValue":e[7]||(e[7]=o=>a.form.notes=o),type:"textarea",autogrow:"",dense:"",outlined:"",label:"Notas"},null,8,["modelValue"])]),_:1}),l(L,{align:"right"},{default:d(()=>[$(l(m,{flat:"",label:"Cancelar"},null,512),[[M]]),l(m,{color:"primary",label:a.dialog.isEdit?"Actualizar":"Crear",loading:a.saving,onClick:n.saveEvent},null,8,["label","loading","onClick"]),a.dialog.isEdit?(C(),v(m,{key:0,flat:"",color:"negative",label:"Eliminar",loading:a.deleting,onClick:n.deleteEvent},null,8,["loading","onClick"])):N("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ft=k(Z,[["render",ot],["__scopeId","data-v-26456edc"]]);export{ft as default};
