import{_ as F,c as n,o as i,w as o,a as s,b as p,a0 as k,$ as P,a1 as D,a2 as U,Z as f,t as h,a5 as G,d as c,W as w,f as u,a6 as b,h as x,Q as q,e as v,a7 as L,a8 as R}from"./index-CganwBAO.js";import{Q as I,b as C,c as m}from"./QMenu-DGfEvXqO.js";import{Q as V}from"./QItemLabel-BWdj69A2.js";import{Q as S}from"./QList-Cuzyr_9T.js";import{Q as M}from"./QBtnDropdown-BFI-20r8.js";import{Q as T,a as Q}from"./QTable-B-YMhWxf.js";import{Q as B}from"./QImg-Cz1tj3AF.js";import{Q as O}from"./QTooltip-CqnqQtBU.js";import{Q as E}from"./QBadge-BoqbdmL7.js";import{Q as N}from"./QSpace-B7DdVKae.js";import{Q as z}from"./QSelect-CIr2Juns.js";import{Q as _}from"./QForm-Dxp_aQTo.js";import{Q as Z}from"./QPage-C17v_2I-.js";import{C as y}from"./ClosePopup-CgDcNLEK.js";import"./format-z10BDj7y.js";import"./QBtnGroup-qWm5Zepn.js";import"./QMarkupTable-C0e_r604.js";import"./use-fullscreen-BYyo9RcM.js";const j={name:"UsuariosPage",data(){return{users:[],user:{},userDialog:!1,loading:!1,actionUser:"",filter:"",roles:["Administrador","Asistente","Psicologo","Abogado","Social","Auxiliar","Director"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"avatar",label:"Avatar",align:"left",field:r=>r.avatar},{name:"role",label:"Rol",align:"left",field:"role"},{name:"area",label:"Área",align:"left",field:"area"},{name:"zona",label:"Zona",align:"left",field:"zona"},{name:"email",label:"Email",align:"left",field:"email"},{name:"celular",label:"Celular",align:"left",field:"celular"},{name:"permissions",label:"Permisos",align:"left",field:r=>(r.permissions||[]).map(e=>e.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1}},async mounted(){this.usersGet()},methods:{async usersGet(){this.loading=!0;try{const r=await this.$axios.get("users");this.users=r.data}catch(r){this.$alert.error(r.response?.data?.message||"Error cargando usuarios")}finally{this.loading=!1}},userNew(){this.user={name:"",username:"",password:"",role:"Asistente",avatar:"default.png",area:"DNA",zona:"CENTRAL",email:"",celular:""},this.actionUser="Nuevo",this.userDialog=!0},userEdit(r){this.user={...r},this.actionUser="Editar",this.userDialog=!0},userDelete(r){this.$alert.dialog("¿Desea eliminar el usuario?").onOk(async()=>{this.loading=!0;try{await this.$axios.delete("users/"+r),this.$alert.success("Usuario eliminado"),this.usersGet()}catch(e){this.$alert.error(e.response?.data?.message||"No se pudo eliminar")}finally{this.loading=!1}})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario creado"),this.usersGet()}).catch(r=>this.$alert.error(r.response?.data?.message||"No se pudo crear")).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put("users/"+this.user.id,this.user).then(()=>{this.userDialog=!1,this.$alert.success("Usuario actualizado"),this.usersGet()}).catch(r=>this.$alert.error(r.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},onFileChange(r){const e=r.target.files[0],g=new FormData;g.append("avatar",e),this.loading=!0,this.$axios.post(`${this.user.id}/avatar`,g,{headers:{"Content-Type":"multipart/form-data"}}).then(()=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(A=>this.$alert.error(A.response?.data?.message||"No se pudo actualizar")).finally(()=>{this.loading=!1})},cambiarAvatar(r){this.cambioAvatarDialogo=!0,this.user={...r}},async permisosShow(r){this.user={...r},this.dialogPermisos=!0,this.loading=!0;try{const e=await this.$axios.get("permissions").then(a=>a.data),g=await this.$axios.get(`users/${r.id}/permissions`).then(a=>a.data),A=new Set(["Dashboard","Usuarios","Lineas de Tiempo","Agenda","Crear SLIM","Ver SLIM","Crear DNA","Ver DNA","Crear SLAM","Ver SLAM","Crear UMADIS","Ver UMADIS","Crear PROPREMI","Ver PROPREMI","Reportes","Acogimiento","Ver Juventudes","Crear Juventudes","Agenda Talleres de Orientación","Antecedentes NNA","Lugar de Acogida NNA","Equipo Responsable","Informes","Remision de Casos"]);this.permissions=e.filter(a=>A.has(a.name)).map(a=>({...a,checked:g.includes(a.id)}))}catch(e){this.$alert.error(e.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const r=this.permissions.filter(e=>e.checked).map(e=>e.id);await this.$axios.put(`users/${this.user.id}/permissions`,{permissions:r}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.usersGet()}catch(r){this.$alert.error(r.response?.data?.message||"No se pudo guardar")}finally{this.loading=!1}},markAll(r){this.permissions=this.permissions.map(e=>({...e,checked:!!r}))},userEditPassword(r){this.user={...r},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(e=>{this.$axios.put("updatePassword/"+r.id,{password:e}).then(()=>{this.$alert.success("Contraseña actualizada de "+r.username),this.usersGet()}).catch(g=>this.$alert.error(g.response?.data?.message||"No se pudo actualizar"))})}},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const r=this.permFilter.toLowerCase();return this.permissions.filter(e=>e.name.toLowerCase().includes(r))}}},J={class:"row items-center q-col-gutter-xs"},K={class:"text-left"},W={class:"text-right"},H={style:{position:"relative"}},X=["src"],Y={class:"text-right"},$={class:"row q-col-gutter-md items-center q-mb-sm"},ee={class:"col"},le={class:"col-auto"};function se(r,e,g,A,a,t){return i(),n(Z,{class:"q-pa-md"},{default:o(()=>[s(T,{rows:a.users,columns:a.columns,dense:"","wrap-cells":"",flat:"",bordered:"","rows-per-page-options":[0],title:"Usuarios",filter:a.filter},{"top-right":o(()=>[s(u,{color:"positive",label:"Nuevo",onClick:t.userNew,"no-caps":"",icon:"add_circle_outline",loading:a.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),s(u,{color:"primary",label:"Actualizar",onClick:t.usersGet,"no-caps":"",icon:"refresh",loading:a.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),s(b,{modelValue:a.filter,"onUpdate:modelValue":e[0]||(e[0]=l=>a.filter=l),label:"Buscar",dense:"",outlined:""},{append:o(()=>[s(c,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":o(l=>[s(Q,{props:l},{default:o(()=>[s(M,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:o(()=>[s(S,null,{default:o(()=>[w((i(),n(C,{clickable:"",onClick:d=>t.userEdit(l.row)},{default:o(()=>[s(m,{avatar:""},{default:o(()=>[s(c,{name:"edit"})]),_:1}),s(m,null,{default:o(()=>[s(V,null,{default:o(()=>e[25]||(e[25]=[f("Editar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[y]]),w((i(),n(C,{clickable:"",onClick:d=>t.userDelete(l.row.id)},{default:o(()=>[s(m,{avatar:""},{default:o(()=>[s(c,{name:"delete"})]),_:1}),s(m,null,{default:o(()=>[s(V,null,{default:o(()=>e[26]||(e[26]=[f("Eliminar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[y]]),w((i(),n(C,{clickable:"",onClick:d=>t.userEditPassword(l.row)},{default:o(()=>[s(m,{avatar:""},{default:o(()=>[s(c,{name:"lock_reset"})]),_:1}),s(m,null,{default:o(()=>[s(V,null,{default:o(()=>e[27]||(e[27]=[f("Cambiar contraseña")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[y]]),w((i(),n(C,{clickable:"",onClick:d=>t.cambiarAvatar(l.row)},{default:o(()=>[s(m,{avatar:""},{default:o(()=>[s(c,{name:"image"})]),_:1}),s(m,null,{default:o(()=>[s(V,null,{default:o(()=>e[28]||(e[28]=[f("Cambiar avatar")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[y]]),w((i(),n(C,{clickable:"",onClick:d=>t.permisosShow(l.row)},{default:o(()=>[s(m,{avatar:""},{default:o(()=>[s(c,{name:"lock"})]),_:1}),s(m,null,{default:o(()=>[s(V,null,{default:o(()=>e[29]||(e[29]=[f("Permisos")])),_:1})]),_:1})]),_:2},1032,["onClick"])),[[y]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":o(l=>[s(Q,{props:l},{default:o(()=>[s(I,{label:l.row.role,color:r.$filters.color(l.row.role),"text-color":"white",dense:"",size:"14px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-avatar":o(l=>[s(Q,{props:l},{default:o(()=>[s(G,{rounded:""},{default:o(()=>[l.row.avatar?(i(),n(B,{key:0,src:`${r.$url}/../images/${l.row.avatar}`,width:"40",height:"40"},null,8,["src"])):(i(),n(c,{key:1,name:"person",size:"40px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-permissions":o(l=>[s(Q,{props:l},{default:o(()=>[p("div",J,[(i(!0),k(D,null,U((l.row.permissions||[]).slice(0,3),(d,ae)=>(i(),n(I,{key:d.id,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:o(()=>[f(h(d.name),1)]),_:2},1024))),128)),(l.row.permissions||[]).length>3?(i(),n(E,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:o(()=>[f(" +"+h((l.row.permissions||[]).length-3)+" ",1),s(O,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:o(()=>[p("div",K,[(i(!0),k(D,null,U(l.row.permissions,d=>(i(),k("div",{key:d.id},"• "+h(d.name),1))),128))])]),_:2},1024)]),_:2},1024)):P("",!0),(l.row.permissions||[]).length?P("",!0):(i(),n(E,{key:1,color:"grey-5","text-color":"white",outline:""},{default:o(()=>e[30]||(e[30]=[f(" Sin permisos ")])),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),s(x,{modelValue:a.userDialog,"onUpdate:modelValue":e[12]||(e[12]=l=>a.userDialog=l),persistent:""},{default:o(()=>[s(q,{style:{width:"400px"}},{default:o(()=>[s(v,{class:"q-pb-none row items-center"},{default:o(()=>[p("div",null,h(a.actionUser)+" usuario",1),s(N),s(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=l=>a.userDialog=!1)})]),_:1}),s(v,{class:"q-pt-none"},{default:o(()=>[s(_,{onSubmit:e[11]||(e[11]=l=>a.user.id?t.userPut():t.userPost())},{default:o(()=>[s(b,{modelValue:a.user.name,"onUpdate:modelValue":e[2]||(e[2]=l=>a.user.name=l),label:"Nombre",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),s(b,{modelValue:a.user.username,"onUpdate:modelValue":e[3]||(e[3]=l=>a.user.username=l),label:"Usuario",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),a.user.id?P("",!0):(i(),n(b,{key:0,modelValue:a.user.password,"onUpdate:modelValue":e[4]||(e[4]=l=>a.user.password=l),label:"Contraseña",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"])),s(z,{modelValue:a.user.role,"onUpdate:modelValue":e[5]||(e[5]=l=>a.user.role=l),label:"Rol",dense:"",outlined:"",options:a.roles,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","rules"]),s(b,{modelValue:a.user.email,"onUpdate:modelValue":e[6]||(e[6]=l=>a.user.email=l),label:"Email",dense:"",outlined:"",hint:""},null,8,["modelValue"]),s(b,{modelValue:a.user.celular,"onUpdate:modelValue":e[7]||(e[7]=l=>a.user.celular=l),label:"Celular",dense:"",outlined:"",hint:""},null,8,["modelValue"]),s(z,{modelValue:a.user.area,"onUpdate:modelValue":e[8]||(e[8]=l=>a.user.area=l),label:"Área",dense:"",outlined:"",options:r.$areas,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","rules"]),s(z,{modelValue:a.user.zona,"onUpdate:modelValue":e[9]||(e[9]=l=>a.user.zona=l),label:"Zona",dense:"",outlined:"",options:r.$zonas,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","rules"]),p("div",W,[s(u,{color:"negative",label:"Cancelar",onClick:e[10]||(e[10]=l=>a.userDialog=!1),"no-caps":"",loading:a.loading},null,8,["loading"]),s(u,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:a.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(x,{modelValue:a.cambioAvatarDialogo,"onUpdate:modelValue":e[18]||(e[18]=l=>a.cambioAvatarDialogo=l),persistent:""},{default:o(()=>[s(q,null,{default:o(()=>[s(v,{class:"q-pb-none row items-center text-bold"},{default:o(()=>[e[31]||(e[31]=f(" Cambiar avatar ")),s(N),s(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[13]||(e[13]=l=>a.cambioAvatarDialogo=!1)})]),_:1}),s(v,{class:"q-pt-none"},{default:o(()=>[s(_,{onSubmit:e[17]||(e[17]=l=>t.userPut())},{default:o(()=>[p("div",null,[p("div",H,[s(u,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:e[14]||(e[14]=l=>r.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""})]),a.user.avatar?(i(),k("img",{key:0,src:`${r.$url}/../images/${a.user.avatar}`,width:"300",height:"300"},null,8,X)):(i(),n(c,{key:1,name:"person",size:"100px"})),p("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:e[15]||(e[15]=(...l)=>t.onFileChange&&t.onFileChange(...l)),accept:"image/*"},null,544)]),p("div",Y,[s(u,{color:"negative",label:"Cancelar",onClick:e[16]||(e[16]=l=>a.cambioAvatarDialogo=!1),"no-caps":"",loading:a.loading},null,8,["loading"]),s(u,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:a.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(x,{modelValue:a.dialogPermisos,"onUpdate:modelValue":e[24]||(e[24]=l=>a.dialogPermisos=l),persistent:""},{default:o(()=>[s(q,{style:{"min-width":"460px"}},{default:o(()=>[s(v,{class:"q-pb-none row items-center text-bold"},{default:o(()=>[f(" Permisos de "+h(a.user.username)+" ",1),s(N),s(u,{icon:"close",flat:"",round:"",dense:"",onClick:e[19]||(e[19]=l=>a.dialogPermisos=!1)})]),_:1}),s(v,{class:"q-pt-none"},{default:o(()=>[p("div",$,[p("div",ee,[s(b,{modelValue:a.permFilter,"onUpdate:modelValue":e[20]||(e[20]=l=>a.permFilter=l),dense:"",outlined:"",placeholder:"Filtrar permisos... (ej. KPIs, Usuarios)"},{append:o(()=>[s(c,{name:"search"})]),_:1},8,["modelValue"])]),p("div",le,[s(u,{dense:"",flat:"",icon:"checklist_rtl",label:"Marcar todo",onClick:e[21]||(e[21]=l=>t.markAll(!0))}),s(u,{dense:"",flat:"",icon:"close",label:"Quitar todo",onClick:e[22]||(e[22]=l=>t.markAll(!1))})])]),s(S,{dense:"",bordered:""},{default:o(()=>[(i(!0),k(D,null,U(t.filteredPermissions,l=>(i(),n(C,{key:l.id},{default:o(()=>[s(m,null,{default:o(()=>[f(h(l.name),1)]),_:2},1024),s(m,{side:""},{default:o(()=>[s(L,{modelValue:l.checked,"onUpdate:modelValue":d=>l.checked=d},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(R,{align:"right"},{default:o(()=>[s(u,{color:"negative",label:"Cancelar",onClick:e[23]||(e[23]=l=>a.dialogPermisos=!1),"no-caps":"",loading:a.loading},null,8,["loading"]),s(u,{color:"primary",label:"Guardar",onClick:t.permisosPost,"no-caps":"",loading:a.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const Ve=F(j,[["render",se]]);export{Ve as default};
